version: '3.8'

services:
  # Servicio de base de datos
  mariadb:
    image: mariadb:10.6
    container_name: monitoreo-ambiental-db
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD:-admin}
      MYSQL_DATABASE: monitoreo_ambiental
    volumes:
      - mariadb_data:/var/lib/mysql
      - ./packages/node-monitoring/database-schema.sql:/docker-entrypoint-initdb.d/init.sql
      - ./packages/node-education/database-schema.sql:/docker-entrypoint-initdb.d/init-education.sql
    ports:
      - "3306:3306"
    networks:
      - monitoreo-network

  # Servicio backend de monitoreo ambiental
  monitoreo-ambiental-api:
    build:
      context: ./packages/node-monitoring
      dockerfile: Dockerfile
    container_name: monitoreo-ambiental-api
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - DB_HOST=mariadb
      - DB_USER=root
      - DB_PASSWORD=${DB_ROOT_PASSWORD:-admin}
      - DB_DATABASE=monitoreo_ambiental
      - IQAIR_API_KEY=${IQAIR_API_KEY}
      - WEATHER_API_KEY=${WEATHER_API_KEY}
    ports:
      - "3000:3000"
    depends_on:
      - mariadb
    networks:
      - monitoreo-network

  # Servicio de educación ambiental
  educacion-ambiental-api:
    build:
      context: ./packages/node-education
      dockerfile: Dockerfile
    container_name: educacion-ambiental-api
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - PORT=3002
      - DB_HOST=mariadb
      - DB_USER=root
      - DB_PASSWORD=${DB_ROOT_PASSWORD:-admin}
      - DB_DATABASE=monitoreo_ambiental
    ports:
      - "3002:3002"
    depends_on:
      - mariadb
      - monitoreo-ambiental-api
    networks:
      - monitoreo-network

  # Aquí puedes añadir los otros servicios de tu docker-compose.yml original
  # como grafana, phpmyadmin, etc.

volumes:
  mariadb_data:
  # Añade aquí otros volúmenes de tu configuración original

networks:
  monitoreo-network:
    driver: bridge